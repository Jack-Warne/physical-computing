#ifndef MATRIXLED_H
#define MATRIXLED_H

#include <Wire.h>

#define VK16K33_CMD_RAM     0x00
#define VK16K33_CMD_SETUP   0x80
#define VK16K33_CMD_DIMMING 0xE0

#define VK16K33_DISPLAY_OFF 0x00
#define VK16K33_DISPLAY_ON  0x01
#define VK16K33_BLINK_OFF   0x00
#define VK16K33_BLINK_1HZ   0x02
#define VK16K33_BLINK_2HZ   0x04
#define VK16K33_BLINK_0HZ5  0x06

class matrixLED {
  public:
    void init(unsigned char addr = 0x71);
    void setBrightness(unsigned char brightness);
    void setBlink(unsigned char blink);
    void flipVertical(void);
    void flipHorizontal(void);
    void clear(void);
    void setRow(unsigned char row, unsigned char value, bool rowDirection = 0);
    void show(void);
    void showStaticArray(byte *array1, byte *array2);
    void showLedMatrix(byte array[8][8], int x_offset = 4, int y_offset = 4);
    void showArray(int delay_ms, int arrayType);

  private:
    unsigned int *_buffer;
    unsigned char  _i2c_addr;
    bool     _vFlipped;
    bool     _hFlipped;
    int      _brightness;
    int count;

    void writeRow(unsigned char row);
    void setPixel(unsigned char row, unsigned char col, unsigned char val, bool rowDirection);
    
    // Predefined patterns
    byte startled_x[8][8] = {
      {0x08,0x14,0x14,0x22,0x22,0x41,0x41,0x80},
      {0x04,0xA,0xA,0x11,0x11,0xA0,0xA0,0x40},
      {0x02,0x05,0x05,0x88,0x88,0x50,0x50,0x20},
      {0x01,0x82,0x82,0x44,0x44,0x28,0x28,0x10},
      {0x80,0x41,0x41,0x22,0x22,0x14,0x14,0x08},
      {0x40,0xA0,0xA0,0x11,0x11,0xA,0xA,0x04},
      {0x20,0x50,0x50,0x88,0x88,0x05,0x05,0x02},
      {0x10,0x28,0x28,0x44,0x44,0x82,0x82,0x01}
    };
    byte startled_y[8][8] = {
      {0x08,0x14,0x14,0x22,0x22,0x41,0x41,0x80},
      {0x04,0xA,0xA,0x11,0x11,0xA0,0xA0,0x40},
      {0x02,0x05,0x05,0x88,0x88,0x50,0x50,0x20},
      {0x01,0x82,0x82,0x44,0x44,0x28,0x28,0x10},
      {0x80,0x41,0x41,0x22,0x22,0x14,0x14,0x08},
      {0x40,0xA0,0xA0,0x11,0x11,0xA,0xA,0x04},
      {0x20,0x50,0x50,0x88,0x88,0x05,0x05,0x02},
      {0x10,0x28,0x28,0x44,0x44,0x82,0x82,0x01}
    };

    // Flexible arrays moved to the end
    byte happy_x[1][8] = {
      {0x00,0x60,0x60,0x30,0x30,0x18,0x1F,0x00}
    };
    byte happy_y[1][8] = {
      {0x00,0x06,0x06,0xC,0xC,0x18,0xF8,0x00}
    };
    byte sad_x[1][8] = {
      {0x00,0x07,0x1F,0x18,0x30,0x30,0x60,0x60}
    };
    byte sad_y[1][8] = {
      {0x00,0xE0,0xF8,0x18,0xC,0xC,0x06,0x06}
    };
};

#endif
